each group in groups
    - if (debug)
        div(style="text-align:left;direction:ltr") #{group.query}
    - if (group.group_field == 'fund_name' )continue;

    //- skip empty groups
    - if (Object.keys(group.result).length == 0 ) continue;

    //- count precent shown in table
    - var visiblePercentage = 0;

    div(class="segmentation")
        h3(class="table-title") חלוקה לפי&nbsp #{translate(group.group_field)}&nbsp
            i(class="help-spot fa fa-question-circle")

        table(class="group-table table table-striped" style="text-align:right;width:100%")
            colgroup()
                col(class="col-xs-3")
                col(class="col-xs-3")
                col(class="col-xs-3")
                col(class="col-xs-3")
            thead()
                tr()
                    th(style="text-align: right") #{translate(group.group_field)}
                    th(style="text-align: right") היקף ההשקעה 
                        span(class="unit") בשקלים

                    - if (report_type == "managing_body"){
                        th(style="text-align: right") חשיפה 
                            span(class="unit") באחוזים
                    - }
                    - else if(report_type == "investment") {
                        th(style="text-align: right") אחוז מההשקעה
                    - }

                    th(style="text-align: right") שינוי חשיפה 
                        span(class="unit") ב-4 רבעונים

            tbody()
                each result in group.result
                    - var lastQStr = lastQuarters[0].year +"_" + lastQuarters[0].quarter;
                    - var lastQResult = result[lastQStr][0];
                    - var lastQResultWords = convertNumberToWords(lastQResult.fair_value);
                    - var groupPercentage = (lastQResult.fair_value / quarters[0]['fair_value'] * 100 ).toFixed(2);
                    //- var escapedVal = rfc3986EncodeURIComponent(lastQResult[group.group_field]);
                    - var groupName = removeQoutes(translate(lastQResult[group.group_field]));
                    - visiblePercentage += Number(groupPercentage);

                    - if (result[group.group_field] === 'NULL' ) continue;

                    - if ( result[lastQStr] != undefined )
                        - var lastQResult = result[lastQStr][0];
                    - else
                        div() UNDEFINED for #{group.group_field} #{removeQoutes(translate(lastQResult[group.group_field]))} #{lastQStr}

                        - result[lastQStr] = [{'fair_value':'0'}];
                        - var lastQResult = result[lastQStr][0];

                        - continue


                    tr()
                        td()
                            - if (groupPercentage == 100){
                                div() #{groupName}
                            - }else{
                                a(class="table-link" onclick="addConstraint('#{group.group_field}','#{lastQResult[group.group_field]}')" title='#{groupName}') #{groupName}
                            -}
                        td()
                            span(class="amount") #{lastQResultWords.number}  #{lastQResultWords.scale}
                        td()
                            span(class="relative-size") #{groupPercentage}%
                            div(id="bar" style="width:#{groupPercentage*(70/100)}%")

                        td(class="change")
                            - var sparkline = [];
                            - for(var i = 0;i<4;i++){
                                - var qStr = lastQuarters[i].year + "_" + lastQuarters[i].quarter;
                                - if (result[qStr] == undefined){
                                    - if (debug){
                                        div() result[#{qStr}] is undefined
                                    - }
                                    - sparkline.push( Number(0) );
                                    - continue;
                                - }
                                - if (quarters[i] == undefined){
                                    - if (debug){
                                        div() quarters[i] is undefined
                                    - }
                                    - sparkline.push( Number(0) );
                                    - continue;
                                - }
                                - sparkline.push( (Number(result[qStr][0]['fair_value']) / Number(quarters[i]['fair_value']) * 100).toFixed(2) );
                            - }

                            - var diff, caret, colorClass;

                            - diff = (sparkline[0] - sparkline[sparkline.length - 1]).toFixed(2);
                            - if (diff > 0){
                                - diff = "+" + diff;
                                - caret = "fa-caret-up";
                                - colorClass = "blue-text";
                            - }
                            - else if(diff==0) {
                                - caret = "";
                                - colorClass = "gray-text-text";
                            - }

                            - else{
                                - caret = "fa-caret-down";
                                - colorClass = "yellow-text";
                            - }

                            span(class="quarter-diff #{colorClass}" )
                                span(class="percentage") #{diff}%
                                i(class="fa #{caret}")
                            div(class="sparkline",data-sparkline="#{sparkline.reverse().join(', ')}")


                - if(visiblePercentage <= 99){
                    tfoot()
                        tr()
                            td(class="list-all")
                                - var linkUrl = "/investments" + filter.toQueryString() + "&group_by=" + group.group_field;
                                a(data-target="#myModal",data-toggle="modal",data-remote="#{linkUrl}")
                                    כל #{plurals[group.group_field]}...
                - }

                - if (debug && visiblePercentage > 100){
                    tr()
                        td()
                            div() סהכ גדול מ100%!! #{visiblePercentage }
                - }

